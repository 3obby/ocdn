OCDN MVP — Task Checklist
==========================

[x] SCAFFOLD
    [x] next.js app (app router), tailwind, prisma        package.json, tsconfig, next.config
    [x] prisma schema: pools, receipts, settlements,       prisma/schema.prisma
        events, importance scores, citation edges
    [x] env: database url, nostr relay urls, founder       .env
        pubkey, mint keys
    [x] protocol constants                                 src/lib/constants.ts

[x] PROTOCOL TYPES (NIP definitions)
    [x] event kind numbers, tag shapes, zod schemas        src/lib/nostr/types.ts
    [x] NIP-POOL: pool credit event build/validate         src/lib/nostr/pool.ts
    [x] NIP-RECEIPT: receipt event build/validate           src/lib/nostr/receipt.ts
    [x] NIP-SETTLE: settlement event build/validate        src/lib/nostr/settle.ts
    [x] NIP-PRESERVE: preservation bid build/validate      src/lib/nostr/preserve.ts
    [x] NIP-OFFER: host offer build/validate               src/lib/nostr/offer.ts
    [x] NIP-CLEARING: clearing result build/validate       src/lib/nostr/clearing.ts

[x] CORE LOGIC
    [x] royalty formula r(v) + split accounting             src/lib/royalty.ts  ← SUPERSEDED: see REVENUE MODEL MIGRATION below
    [x] pool mechanics: accumulate, drain, epoch cap        src/lib/pool.ts
    [x] receipt verification (ed25519 + pow check)          src/lib/receipt.ts
    [x] importance computation (commitment × demand ×       src/lib/importance/index.ts
        centrality), divergence labels
    [x] citation graph: edge extraction, pagerank           src/lib/importance/graph.ts
    [x] relay subscription client (nostr-tools)             src/lib/nostr/relay.ts
    [x] blossom client (upload, fetch, L402 flow)           src/lib/blossom/client.ts
    [x] prisma client singleton                             src/lib/db.ts

[x] SETTLER / BACKGROUND SERVICES
    [x] relay subscriber: ingest pool+receipt events        src/workers/relay-sub.ts
    [x] epoch settler: compute rewards, publish settle      src/workers/settler.ts
    [x] clearinghouse: match preserve↔offer at boundary     src/workers/clearing.ts

[x] API ROUTES
    [x] GET /api/pool/[hash]: balance, funders, drain       src/app/api/pool/[hash]/route.ts
    [x] GET /api/importance: ranked list, filters            src/app/api/importance/route.ts
    [x] GET /api/events: event stream query                  src/app/api/events/route.ts
    [x] GET /api/sse: server-sent events (live updates)      src/app/api/sse/route.ts
    [x] POST /api/fortify: accept pool credit + payment      src/app/api/fortify/route.ts
    [x] POST /api/preserve: accept preserve bid              src/app/api/preserve/route.ts
    [x] GET /api/resolve/[input]: ref resolver backend       src/app/api/resolve/[input]/route.ts

[x] PAGES
    [x] layout: header, stats bar, nip-07 auth               src/app/layout.tsx
    [x] / leaderboard: ranked feed, expandable cards          src/app/page.tsx
    [x] /v/[ref] content detail: blob embed + instrument      src/app/v/[ref]/page.tsx
        cluster + discussion + fortify + citations
    [x] /verify/[ref] integrity proof page                    src/app/verify/[ref]/page.tsx

[x] COMPONENTS
    [x] LeaderboardFeed + ContentCard (expandable)            src/components/leaderboard/
    [x] InstrumentCluster (funding, demand, replicas,         src/components/content/
        sustainability, citations, preserve backers)
    [x] BlobEmbed (render pdf/image/text from blossom)        src/components/content/BlobEmbed.tsx
    [x] Discussion (nostr threaded replies)                   src/components/content/Discussion.tsx
    [x] CitationList (cited-by / cites, flat)                 src/components/content/CitationList.tsx
    [x] FortifyButton (preserve/fortify/fund modes)           src/components/fortify/FortifyButton.tsx
    [x] RefResolver (paste url/hash/drop file)                src/components/resolve/RefResolver.tsx
    [x] Header + live stats                                   src/components/shared/Header.tsx

[x] WIDGET
    [x] standalone web component: compact leaderboard +       src/widget/embed.ts
        fortify, CDN-ready build

--- INTEGRATION WORK (DONE) ---

[x] WIRING
    [x] real NIP-07 (browser extension) identity flow         src/lib/nostr/identity.ts
    [x] real Lightning payment integration (invoices+WebLN)    src/components/fortify/FortifyButton.tsx
    [x] SSE wiring: connect pages/components to /api/sse      src/hooks/useSSE.ts
    [x] header live stats: fetch doc count, total sats         src/components/shared/Header.tsx + /api/stats
    [x] OG image generation per content hash                   src/app/v/[ref]/opengraph-image.tsx
    [x] file drop support in RefResolver                       src/components/resolve/RefResolver.tsx
    [x] discussion: real nostr event subscription              src/components/content/Discussion.tsx
    [x] ephemeral key → claim funding flow                     src/lib/nostr/identity.ts
    [x] worker startup (settler + relay-sub + clearing)        src/app/api/workers/route.ts

[x] INFRA (partial)
    [x] prisma migrate: create initial migration               prisma/migrations/0001_init/
    [ ] deploy postgres                                        .env DATABASE_URL
    [ ] configure real nostr relay URLs                         .env NOSTR_RELAYS
    [ ] generate + distribute mint keypairs                     .env MINT_PRIVATE_KEY
    [ ] set FOUNDER_PUBKEY                                      .env

--- CORE LOOP: Fortify → Share → Push ---
--- Build as one pipeline. Each step unblocks the next. ---

STEP 1: FORTIFY (simplify the revenue action)

    [x] strip FortifyButton to single mode: button + amount       src/components/fortify/FortifyButton.tsx
        presets (21/100/1k/10k) + pay. kill mode selector,
        kill "fund" mode, hide preserve entirely for now.
    [x] after successful payment: show confirmation + share        src/components/fortify/FortifyButton.tsx
        prompt inline ("You fortified this. Share it.")

STEP 2: SHARE (close the viral loop)

    [x] share button on /v/[ref]: copy link + Nostr + Twitter     src/app/v/[ref]/page.tsx
        (OG card already exists — it IS the payload)
    [x] share button on leaderboard ContentCard                    src/components/leaderboard/Card.tsx
    [x] post-Fortify share: surface share buttons immediately      src/components/fortify/FortifyButton.tsx
        after payment success (Fortify→Share is one motion)

STEP 3: PUSH (let users bring content)

    [x] RefResolver: detect file input, upload to Blossom via      src/components/resolve/RefResolver.tsx
        uploadBlob(), create pool entry via POST /api/push,        src/lib/blossom/client.ts
        redirect to /v/{hash}
    [x] POST /api/push: create pool entry + optional announce      src/app/api/push/route.ts
    [x] /v/[ref] not-indexed state: show "Push" CTA instead        src/app/v/[ref]/page.tsx
        of bare Fortify on an empty hash

--- ECOSYSTEM INTEGRATION (DONE) ---

[x] NOSTR RELAY PUBLISHING
    [x] publish NIP-POOL events to relays on fortify               src/app/api/fortify/route.ts
    [x] publish NIP-IMPORTANCE events to relays                    src/workers/settler.ts
    [x] accept inbound Zaps as pool credits                        src/workers/relay-sub.ts

[x] POLISH
    [x] embed code generator ("Embed this" snippet)                src/components/content/EmbedGenerator.tsx
    [x] live activity feed (funding events, new content)           src/components/shared/ActivityFeed.tsx

--- CONTENT VISIBILITY: Upload → Preview → Review ---
--- Problem: user uploads a file, sees "Not served by any host" ---
--- with zero evidence the file is there. No preview, no type, nothing. ---

[x] CONTENT METADATA (persist what we know about uploaded files)
    [x] add ContentMeta model: hash, fileName, fileType,           prisma/schema.prisma
        fileSize, uploadedBy, status (pending|live|rejected),
        uploadedAt. Relation to Pool.
    [x] /api/push: persist ContentMeta on upload, status=pending    src/app/api/push/route.ts
    [x] /v/[ref] page: load ContentMeta, pass to BlobEmbed          src/app/v/[ref]/page.tsx
    [x] leaderboard Card: show fileName/fileType instead of         src/components/leaderboard/Card.tsx
        raw hash when metadata exists

[x] UPLOAD PREVIEW (show the file the user just pushed)
    [x] RefResolver: after hashing+uploading, stash file bytes      src/components/resolve/RefResolver.tsx
        in sessionStorage as base64 data URL (capped ~10MB)
    [x] BlobEmbed: check sessionStorage for local preview           src/components/content/BlobEmbed.tsx
        before hitting Blossom servers — instant render
    [x] clear sessionStorage preview after page reload or           src/components/content/BlobEmbed.tsx
        after Blossom fetch succeeds

[x] SMART "NOT SERVED" STATE (type-aware placeholder)
    [x] BlobEmbed: when not_served but ContentMeta exists,          src/components/content/BlobEmbed.tsx
        show type-appropriate placeholder:
        — image: camera icon + "Image · 2.4 MB · vacation.jpg"
        — pdf: doc icon + "PDF · 1.1 MB · filing.pdf"
        — text: text icon + file name + size
        — other: generic file icon + type + size
    [x] show upload status badge: "Pending review" / "Live"         src/components/content/BlobEmbed.tsx
        so user knows the operator hasn't rejected it
    [x] "Not served" message only when no metadata AND              src/components/content/BlobEmbed.tsx
        Blossom HEAD fails — true orphan, not fresh upload

[x] OPERATOR REVIEW (simple moderation queue)
    [x] GET /api/admin/queue: list ContentMeta status=pending       src/app/api/admin/queue/route.ts
    [x] POST /api/admin/review: approve/reject content hash         src/app/api/admin/review/route.ts
        (sets status to live or rejected)
    [x] /v/[ref]: if status=rejected, show "Content removed         src/app/v/[ref]/page.tsx
        by operator" instead of blob embed
    [x] basic auth guard for /api/admin/* routes                    src/lib/admin-auth.ts

--- PROTOCOL UPDATE: Index-as-Market-Maker ---
--- Zero protocol fees. Revenue from index attribution + clearing spread. ---
--- Host storage scarcity curve. Cashu ecash escrow. ---

[ ] REVENUE MODEL MIGRATION
    [ ] replace royalty formula with index attribution logic          src/lib/attribution.ts
        (was src/lib/royalty.ts — old r(v) + split accounting is obsolete)
    [ ] index_payout = drain × attributed_share × 0.20               src/lib/attribution.ts
        attributed_share = U_i × log2(1+R_i) / Σ(U_j × log2(1+R_j))
    [ ] update settler: remove royalty deduction from pool credits,   src/workers/settler.ts
        add index attribution accounting to settlement output
    [ ] update pool accumulation: pool[ref] += sats (no royalty       src/lib/pool.ts
        deducted — 100% credited)
    [ ] update NIP-SETTLE event builder: index_payout tag uses        src/lib/nostr/settle.ts
        new attribution formula, not ROYALTY_SPLIT_INDEX

[ ] CONSTANTS UPDATE
    [ ] remove: FOUNDER_ROYALTY_R0, FOUNDER_ROYALTY_V_STAR,           src/lib/constants.ts
        FOUNDER_ROYALTY_ALPHA, EGRESS_ROYALTY_PCT,
        ROYALTY_SPLIT_FOUNDER, ROYALTY_SPLIT_SETTLER,
        ROYALTY_SPLIT_INDEX, ROYALTY_SPLIT_DEV
    [ ] add: INDEX_ATTRIBUTION_PCT = 0.20                             src/lib/constants.ts
    [ ] add: CLEARING_SPREAD_PCT = 0.05 (was 0.03)                   src/lib/constants.ts
    [ ] add: SETTLER_FEE_PCT = 0.01-0.03                             src/lib/constants.ts
    [ ] add: BASE_STORAGE_RATE = 1 sat/GB/epoch                      src/lib/constants.ts
    [ ] add: SCARCITY_EXPONENT = 1.0                                  src/lib/constants.ts
    [ ] add: EVICTION_HYSTERESIS = 1.2                                src/lib/constants.ts

[ ] CLEARINGHOUSE UPDATE
    [ ] update spread from 3% to 5%                                   src/workers/clearing.ts
    [ ] replace trust-based Lightning escrow with Cashu ecash          src/workers/clearing.ts
        escrow (non-custodial from day 1)
    [ ] update NIP-CLEARING event: spread tag = 5%                    src/lib/nostr/clearing.ts

[ ] HOST STORAGE ECONOMICS
    [ ] scarcity curve: storage_cost = BASE_STORAGE_RATE ×             src/lib/storage/scarcity.ts
        (1 - utilization)^(-SCARCITY_EXPONENT)
    [ ] host capacity announcement event kind: total_bytes,            src/lib/nostr/types.ts
        utilization, storage_base_rate, scarcity_exponent              src/lib/nostr/host.ts
    [ ] eviction logic: evict when cost > revenue ×                    src/lib/storage/eviction.ts
        EVICTION_HYSTERESIS for consecutive epochs
    [ ] eviction event kind (auditable: reason, utilization,           src/lib/nostr/types.ts
        cost, revenue at eviction)                                     src/lib/nostr/host.ts
    [ ] host acceptance policy config: previously_served,              src/lib/storage/policy.ts
        trusted_uploaders, auto_accept (min_pool, max_size,
        allowed_types), reject rules
    [ ] opportunity scanner: watch for high-pool/low-host CIDs,        src/workers/opportunity.ts
        auto-mirror if passes acceptance policy + capacity

[ ] SURVIVABILITY PROJECTIONS
    [ ] compute projected_epochs = pool_balance /                      src/lib/importance/survivability.ts
        (net_drain_rate - auto_bid_income) per CID
    [ ] add survivability to InstrumentCluster display                 src/components/content/InstrumentCluster.tsx
    [ ] add funding quote to FortifyButton: "Fund X sats →             src/components/fortify/FortifyButton.tsx
        extends to ~Y days at current rates"
    [ ] GET /api/pool/[hash]: add survivability_epochs,                src/app/api/pool/[hash]/route.ts
        net_drain_rate, auto_bid_income to response

[ ] SCHEMA UPDATE
    [ ] add HostCapacity model: pubkey, totalBytes, usedBytes,         prisma/schema.prisma
        storageBaseRate, scarcityExponent, updatedAt
    [ ] add EvictionEvent model: hash, hostPubkey, reason,             prisma/schema.prisma
        utilization, costAtEviction, revenueAtEviction, epoch
    [ ] add indexAttribution fields to Settlement model:               prisma/schema.prisma
        indexPubkey, attributedShare, attributionPayout

--- HIERARCHY + DISCUSSION ECONOMICS ---
--- Topic hashes, PoW-gated comments, discussion upflow, loss accountability ---

[ ] TOPIC PAGES
    [ ] /t/[topicHash] page: list children ranked by importance      src/app/t/[topicHash]/page.tsx
    [ ] aggregate economics: total sats across topic + descendants   src/app/t/[topicHash]/page.tsx
    [ ] loss visibility: count lost docs under topic                 src/app/t/[topicHash]/page.tsx
    [ ] topic edge extraction: materializer resolves ["t"] tags      src/lib/importance/graph.ts

[ ] COMMENT POW
    [ ] NIP-13 PoW validation for comment events                    src/lib/nostr/comment.ts
    [ ] escalating difficulty per pubkey/thread/day                  src/lib/nostr/comment.ts
    [ ] Discussion component: reject comments below PoW target      src/components/content/Discussion.tsx

[ ] DISCUSSION UPFLOW
    [ ] on comment tip: split DISCUSSION_UPFLOW_PCT to root pool    src/app/api/fortify/route.ts
    [ ] ref chain resolver: comment → parent → … → root hash        src/lib/nostr/refchain.ts
    [ ] display "discussion contributed X sats" on content page      src/components/content/InstrumentCluster.tsx

[ ] LOSS ACCOUNTABILITY
    [ ] "lost" state detection: pool exists + historical receipts    src/lib/pool.ts
        + zero current receipts
    [ ] /v/[ref] lost state UI: pool history, last hosts, last      src/app/v/[ref]/page.tsx
        epoch served, Bitcoin anchor proof, Fortify-to-restore
    [ ] discussion derived durability: warn when root not served     src/components/content/Discussion.tsx

[ ] CONSTANTS (hierarchy/discussion)
    [ ] add COMMENT_POW_TARGET, DISCUSSION_UPFLOW_PCT,              src/lib/constants.ts
        POW_SIZE_UNIT (revenue model constants handled above)
    [ ] add topic edge kind to nostr types                          src/lib/nostr/types.ts

[ ] SCHEMA
    [ ] add TopicNode model or extend Pool for abstract nodes       prisma/schema.prisma
    [ ] add loss tracking fields: lastServedEpoch, lastHosts        prisma/schema.prisma
