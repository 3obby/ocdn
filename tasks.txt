OCDN MVP — Task Checklist
==========================

[x] SCAFFOLD
    [x] next.js app (app router), tailwind, prisma        package.json, tsconfig, next.config
    [x] prisma schema: pools, receipts, settlements,       prisma/schema.prisma
        events, importance scores, citation edges
    [x] env: database url, nostr relay urls, founder       .env
        pubkey, mint keys
    [x] protocol constants                                 src/lib/constants.ts

[x] PROTOCOL TYPES (NIP definitions)
    [x] event kind numbers, tag shapes, zod schemas        src/lib/nostr/types.ts
    [x] NIP-POOL: pool credit event build/validate         src/lib/nostr/pool.ts
    [x] NIP-RECEIPT: receipt event build/validate           src/lib/nostr/receipt.ts
    [x] NIP-SETTLE: settlement event build/validate        src/lib/nostr/settle.ts
    [x] NIP-PRESERVE: preservation bid build/validate      src/lib/nostr/preserve.ts
    [x] NIP-OFFER: host offer build/validate               src/lib/nostr/offer.ts
    [x] NIP-CLEARING: clearing result build/validate       src/lib/nostr/clearing.ts

[x] CORE LOGIC
    [x] royalty formula r(v) + split accounting             src/lib/royalty.ts  ← SUPERSEDED: replace with venue fee (launch task 2)
    [x] pool mechanics: accumulate, drain, epoch cap        src/lib/pool.ts
    [x] receipt verification (ed25519 + pow check)          src/lib/receipt.ts
    [x] importance computation (commitment × demand ×       src/lib/importance/index.ts
        centrality), divergence labels
    [x] citation graph: edge extraction, pagerank           src/lib/importance/graph.ts
    [x] relay subscription client (nostr-tools)             src/lib/nostr/relay.ts
    [x] blossom client (upload, fetch, L402 flow)           src/lib/blossom/client.ts
    [x] prisma client singleton                             src/lib/db.ts

[x] SETTLER / BACKGROUND SERVICES
    [x] relay subscriber: ingest pool+receipt events        src/workers/relay-sub.ts
    [x] epoch settler: compute rewards, publish settle      src/workers/settler.ts
    [x] clearinghouse: match preserve↔offer at boundary     src/workers/clearing.ts

[x] API ROUTES
    [x] GET /api/pool/[hash]: balance, funders, drain       src/app/api/pool/[hash]/route.ts
    [x] GET /api/importance: ranked list, filters            src/app/api/importance/route.ts
    [x] GET /api/events: event stream query                  src/app/api/events/route.ts
    [x] GET /api/sse: server-sent events (live updates)      src/app/api/sse/route.ts
    [x] POST /api/fortify: accept pool credit + payment      src/app/api/fortify/route.ts
    [x] POST /api/preserve: accept preserve bid              src/app/api/preserve/route.ts
    [x] GET /api/resolve/[input]: ref resolver backend       src/app/api/resolve/[input]/route.ts

[x] PAGES (legacy — being simplified to one-surface design)
    [x] layout: header, stats bar, nip-07 auth               src/app/layout.tsx
    [x] / leaderboard: ranked feed, expandable cards          src/app/page.tsx
    [x] /v/[ref] content detail (→ merge into feed card)      src/app/v/[ref]/page.tsx
    [x] /verify/[ref] integrity proof page                    src/app/verify/[ref]/page.tsx

[x] COMPONENTS (legacy — being simplified)
    [x] LeaderboardFeed + ContentCard (expandable)            src/components/leaderboard/
    [x] InstrumentCluster (→ simplify to ⚡N + funders)        src/components/content/
    [x] BlobEmbed (→ REMOVE: replace with source links)       src/components/content/BlobEmbed.tsx
    [x] Discussion (nostr threaded replies)                   src/components/content/Discussion.tsx
    [x] CitationList (cited-by / cites, flat)                 src/components/content/CitationList.tsx
    [x] FortifyButton (→ [+] only, real Lightning via LNbits) src/components/fortify/FortifyButton.tsx
    [x] RefResolver (paste url/hash/drop file)                src/components/resolve/RefResolver.tsx
    [x] Header + live stats                                   src/components/shared/Header.tsx

[x] WIDGET
    [x] standalone web component: compact leaderboard +       src/widget/embed.ts
        fortify, CDN-ready build

--- LAUNCH MVP ---
--- Conviction scoreboard + [+] fund + real Lightning + venue fee + deploy ---
--- Test: will people spend sats to rank propositions? ---
--- Build order: 1→2→3→4→5→6→7→8→9→10→11→12 (1 is gating) ---

[ ] 1. LIGHTNING PAYMENT BACKEND (gating item — nothing works without this)
    [ ] deploy LNbits (self-hosted on VPS alongside app)             infra
    [ ] src/lib/lightning.ts: create invoice, check payment           src/lib/lightning.ts
        status via LNbits REST API
    [ ] /api/fortify: generate invoice → return bolt11 →              src/app/api/fortify/route.ts
        credit pool ONLY after payment confirmed (webhook/poll)
    [ ] FortifyButton: pay via WebLN (desktop) or show               src/components/fortify/FortifyButton.tsx
        QR / "Open Wallet" deep-link (mobile), poll for confirm

[ ] 2. VENUE FEE (replaces old royalty system)
    [ ] add VENUE_FEE_PCT = 0.03 to constants                        src/lib/constants.ts
    [ ] remove FOUNDER_ROYALTY_* / EGRESS_ROYALTY_PCT /                src/lib/constants.ts
        ROYALTY_SPLIT_* constants
    [ ] replace royalty.ts: venueFee() + netAfterVenueFee()           src/lib/royalty.ts
        (8 lines replaces 48)
    [ ] fortify: 97% → pool, 3% stays in LN wallet                   src/app/api/fortify/route.ts
    [ ] relay-sub: credit 100% on protocol events (no fee)            src/workers/relay-sub.ts
    [ ] settler: remove royalty computation from settlement            src/workers/settler.ts

[ ] 3. FIX NIP EVENT KINDS
    [ ] move NIP_POOL_KIND etc from 30000+ range (replaceable         src/lib/constants.ts
        per NIP-33) to 1000-9999 (non-replaceable). Pool credits
        MUST be additive. Current kinds silently break on relays.

[ ] 4. REAL-TIME SSE ON FUNDING
    [ ] fortify route emits SSE event after confirmed credit          src/app/api/fortify/route.ts
    [ ] Card subscribes to SSE for own hash, updates balance          src/components/leaderboard/Card.tsx

[ ] 5. REMOVE REVIEW GATE
    [ ] /api/push: default ContentMeta status to "live"               src/app/api/push/route.ts
        (operator moderates post-hoc, not pre-publication)

[ ] 6. PROPOSITION / TEXT / LINK POSTING (volume expander — propositions are first-class)
    [ ] RefResolver: text proposition + URL mode (not just file upload) src/components/resolve/RefResolver.tsx
    [ ] POST /api/push: accept text claim as proposition, hash the     src/app/api/push/route.ts
        claim text → pool key. Optional link URL attachment.
    [ ] proposition display: claim text shown on card, fundable         src/components/leaderboard/Card.tsx

[ ] 7. VISUAL OG CARD
    [ ] Satori-rendered image: name, pool balance, funder count,      src/app/v/[ref]/opengraph-image.tsx
        reply count — visually compelling enough to click on social

[ ] 8. DEPLOY
    [ ] deploy postgres + LNbits on VPS                               infra
    [ ] configure nostr relay URLs                                    .env NOSTR_RELAYS
    [ ] generate mint keypair                                         .env MINT_PRIVATE_KEY
    [ ] set FOUNDER_PUBKEY                                            .env
    [ ] deploy Next.js app                                            (Vercel / VPS)

[ ] 9. SEED
    [ ] post 20-30 timely propositions / contested documents —
        pick LIVE arguments (this week's Twitter/Nostr fights)
    [ ] seed initial pools (100-500 sats each, ~15K sats total)
    [ ] seed at least 3 head-to-head pairs (claim vs counter-claim)
    [ ] share on Nostr: "put your money where your mouth is"

[ ] 10. CASHU PRE-FUNDED WALLET (volume multiplier — eliminate payment friction)
    [ ] browser-side Cashu ecash wallet (cashu-ts)                    src/lib/cashu-wallet.ts
    [ ] deposit flow: Lightning invoice → mint ecash → store in        src/components/wallet/
        browser (localStorage or IndexedDB)
    [ ] FortifyButton: if wallet has balance, one-tap instant debit    src/components/fortify/FortifyButton.tsx
        (no invoice, no WebLN popup). Fall back to invoice if empty.
    [ ] wallet balance indicator in header                             src/components/shared/Header.tsx

[ ] 11. ZAP-TO-POOL BRIDGE (capture existing Nostr economic flow)
    [ ] relay-sub: detect inbound Zap receipts (kind 9735) to         src/workers/relay-sub.ts
        indexed content hashes, credit pool (minus 3% venue fee)
    [ ] display zap-sourced funding on cards ("⚡ via Nostr zap")       src/components/leaderboard/Card.tsx

[ ] 12. HEAD-TO-HEAD DISPLAY (competitive volume driver)
    [ ] detect funded contradictions: reply with pool > threshold       src/lib/importance/index.ts
        that contradicts parent → surface as head-to-head pair
    [ ] tug-of-war card: both sides, both pools, live-updating,        src/components/leaderboard/HeadToHead.tsx
        competitive framing ("your side is losing")
    [ ] head-to-head section on feed (above or interleaved)            src/app/page.tsx

--- INTEGRATION WORK (DONE) ---

[x] WIRING
    [x] real NIP-07 (browser extension) identity flow         src/lib/nostr/identity.ts
    [x] real Lightning payment integration (invoices+WebLN)    src/components/fortify/FortifyButton.tsx
    [x] SSE wiring: connect pages/components to /api/sse      src/hooks/useSSE.ts
    [x] header live stats: fetch doc count, total sats         src/components/shared/Header.tsx + /api/stats
    [x] OG image generation per content hash                   src/app/v/[ref]/opengraph-image.tsx
    [x] file drop support in RefResolver                       src/components/resolve/RefResolver.tsx
    [x] discussion: real nostr event subscription              src/components/content/Discussion.tsx
    [x] ephemeral key → claim funding flow                     src/lib/nostr/identity.ts
    [x] worker startup (settler + relay-sub + clearing)        src/app/api/workers/route.ts

[x] INFRA (partial — remaining deploy items moved to LAUNCH above)
    [x] prisma migrate: create initial migration               prisma/migrations/0001_init/

--- CORE LOOP: Fortify → Share → Push ---
--- Build as one pipeline. Each step unblocks the next. ---

STEP 1: FORTIFY (simplify the revenue action)

    [x] strip FortifyButton to single mode: button + amount       src/components/fortify/FortifyButton.tsx
        presets (21/100/1k/10k) + pay. kill mode selector,
        kill "fund" mode, hide preserve entirely for now.
    [x] after successful payment: show confirmation + share        src/components/fortify/FortifyButton.tsx
        prompt inline ("You fortified this. Share it.")

STEP 2: SHARE (close the viral loop)

    [x] share button on /v/[ref]: copy link + Nostr + Twitter     src/app/v/[ref]/page.tsx
        (OG card already exists — it IS the payload)
    [x] share button on leaderboard ContentCard                    src/components/leaderboard/Card.tsx
    [x] post-Fortify share: surface share buttons immediately      src/components/fortify/FortifyButton.tsx
        after payment success (Fortify→Share is one motion)

STEP 3: PUSH (let users bring content)

    [x] RefResolver: detect file input, upload to Blossom via      src/components/resolve/RefResolver.tsx
        uploadBlob(), create pool entry via POST /api/push,        src/lib/blossom/client.ts
        redirect to /v/{hash}
    [x] POST /api/push: create pool entry + optional announce      src/app/api/push/route.ts
    [x] /v/[ref] not-indexed state: show "Push" CTA instead        src/app/v/[ref]/page.tsx
        of bare Fortify on an empty hash

--- ECOSYSTEM INTEGRATION (DONE) ---

[x] NOSTR RELAY PUBLISHING
    [x] publish NIP-POOL events to relays on fortify               src/app/api/fortify/route.ts
    [x] publish NIP-IMPORTANCE events to relays                    src/workers/settler.ts
    [x] accept inbound Zaps as pool credits                        src/workers/relay-sub.ts

[x] POLISH
    [x] embed code generator ("Embed this" snippet)                src/components/content/EmbedGenerator.tsx
    [x] live activity feed (funding events, new content)           src/components/shared/ActivityFeed.tsx

--- CONTENT VISIBILITY: Upload → Preview → Review ---
--- Problem: user uploads a file, sees "Not served by any host" ---
--- with zero evidence the file is there. No preview, no type, nothing. ---

[x] CONTENT METADATA (persist what we know about uploaded files)
    [x] add ContentMeta model: hash, fileName, fileType,           prisma/schema.prisma
        fileSize, uploadedBy, status (pending|live|rejected),
        uploadedAt. Relation to Pool.
    [x] /api/push: persist ContentMeta on upload, status=pending    src/app/api/push/route.ts
    [x] /v/[ref] page: load ContentMeta, pass to BlobEmbed          src/app/v/[ref]/page.tsx
    [x] leaderboard Card: show fileName/fileType instead of         src/components/leaderboard/Card.tsx
        raw hash when metadata exists

[x] UPLOAD PREVIEW (show the file the user just pushed)
    [x] RefResolver: after hashing+uploading, stash file bytes      src/components/resolve/RefResolver.tsx
        in sessionStorage as base64 data URL (capped ~10MB)
    [x] BlobEmbed: check sessionStorage for local preview           src/components/content/BlobEmbed.tsx
        before hitting Blossom servers — instant render
    [x] clear sessionStorage preview after page reload or           src/components/content/BlobEmbed.tsx
        after Blossom fetch succeeds

[x] SMART "NOT SERVED" STATE (type-aware placeholder)
    [x] BlobEmbed: when not_served but ContentMeta exists,          src/components/content/BlobEmbed.tsx
        show type-appropriate placeholder:
        — image: camera icon + "Image · 2.4 MB · vacation.jpg"
        — pdf: doc icon + "PDF · 1.1 MB · filing.pdf"
        — text: text icon + file name + size
        — other: generic file icon + type + size
    [x] show upload status badge: "Pending review" / "Live"         src/components/content/BlobEmbed.tsx
        so user knows the operator hasn't rejected it
    [x] "Not served" message only when no metadata AND              src/components/content/BlobEmbed.tsx
        Blossom HEAD fails — true orphan, not fresh upload

[x] OPERATOR REVIEW (simple moderation queue)
    [x] GET /api/admin/queue: list ContentMeta status=pending       src/app/api/admin/queue/route.ts
    [x] POST /api/admin/review: approve/reject content hash         src/app/api/admin/review/route.ts
        (sets status to live or rejected)
    [x] /v/[ref]: if status=rejected, show "Content removed         src/app/v/[ref]/page.tsx
        by operator" instead of blob embed
    [x] basic auth guard for /api/admin/* routes                    src/lib/admin-auth.ts

--- POST-MVP (build when triggered by usage) ---
--- Each feature triggered by real usage signal, not roadmap. ---

[ ] INTERFACE POLISH (trigger: organic usage observed)
    [ ] merge /v/[ref] into feed: card expand inline                 src/app/page.tsx
    [ ] remove BlobEmbed: external source links only                 src/components/content/
    [ ] topic cards: nested expand, aggregate economics              src/components/leaderboard/Card.tsx
    [ ] widget update: same card component, two modes                src/widget/embed.ts
    [ ] resolver inline at top of feed                               src/app/page.tsx

[ ] ATTRIBUTION + SETTLEMENT (trigger: L402 consumption is real)
    [ ] index attribution logic                                      src/lib/attribution.ts
        index_payout = drain × attributed_share × 0.20
    [ ] update settler: attribution accounting                       src/workers/settler.ts
    [ ] update NIP-SETTLE: index_payout tag                          src/lib/nostr/settle.ts

[ ] RECEIPT ECONOMICS (trigger: hosts want pool revenue)
    [ ] NIP-RECEIPT spec + Blossom server addon                      src/lib/nostr/receipt.ts
    [ ] distribute 3-5 mint keypairs across jurisdictions
    [ ] L402 gating on Blossom fetches

[ ] CLEARINGHOUSE (trigger: preservation demand from users)
    [ ] update spread to 5%                                          src/workers/clearing.ts
    [ ] Cashu ecash escrow (non-custodial)                           src/workers/clearing.ts

[ ] HOST STORAGE ECONOMICS (trigger: host count > 5)
    [ ] scarcity curve                                               src/lib/storage/scarcity.ts
    [ ] host capacity announcements                                  src/lib/nostr/host.ts
    [ ] eviction logic + events                                      src/lib/storage/eviction.ts
    [ ] acceptance policy + opportunity scanner                      src/lib/storage/policy.ts

[ ] SURVIVABILITY PROJECTIONS (trigger: pools draining visibly)
    [ ] projected_epochs per CID                                     src/lib/importance/survivability.ts
    [ ] funding quote on FortifyButton                               src/components/fortify/FortifyButton.tsx

[ ] INDEX DELEGATION + INCOME PROTECTION (trigger: income justifies ceremony)
    [ ] NIP-INDEX-DELEGATION events                                  src/lib/nostr/index-delegation.ts
    [ ] 2-of-3 FROST threshold key generation                       (operational — key ceremony)
    [ ] NIP-INDEX-BENEFICIARY + heartbeat                            src/lib/nostr/index-beneficiary.ts
    [ ] anchor tx: epoch_root + attribution payouts                  src/lib/bitcoin/anchor.ts

[ ] ANONYMOUS FUNDING (trigger: demand for privacy)
    [ ] Cashu proof + ephemeral key NIP-POOL                         src/app/api/fortify/route.ts
    [ ] "Fund anonymously" option on FortifyButton                   src/components/fortify/FortifyButton.tsx

[ ] BITCOIN INSCRIPTIONS (trigger: demand for permanence)
    [ ] NIP-INSCRIBE envelope format + batching                      src/lib/bitcoin/inscribe.ts
    [ ] materializer: ingest inscriptions into graph                 src/workers/relay-sub.ts
    [ ] inscription service API                                      src/app/api/inscribe/route.ts

[ ] EDGE ARCHIVE (trigger: graph large enough)
    [ ] NIP-EDGE-ARCHIVE event + periodic snapshot                   src/lib/nostr/edge-archive.ts
    [ ] materializer cold-start from archive blob                    src/workers/settler.ts

[ ] TOPIC HIERARCHY (trigger: enough content to organize)
    [ ] /t/[topicHash] page + aggregate economics                    src/app/t/[topicHash]/page.tsx
    [ ] topic edge extraction in graph                               src/lib/importance/graph.ts

[ ] THREADED FUNDED DISCUSSION (trigger: active discussion observed)
    [ ] threaded display: comments nest by parent event ID            src/components/content/Discussion.tsx
    [ ] [+] button on each reply (event ID as pool key)              src/components/content/Discussion.tsx
    [ ] reply pool balance displayed inline [N⚡]                     src/components/content/Discussion.tsx
    [ ] comment PoW: NIP-13, escalating difficulty per pubkey/day    src/lib/pow.ts (new)
    [ ] excess PoW as conviction signal (8×PoW badge)                src/components/content/Discussion.tsx
    [ ] reply edges in graph: type="reply", weight from pool balance src/lib/importance/graph.ts
    [ ] discussion upflow: reply tip → root pool credit              src/app/api/fortify/route.ts
    [ ] "Contested" divergence label: high funded-reply density      src/lib/importance/index.ts

[ ] LOSS ACCOUNTABILITY (trigger: content actually lost)
    [ ] "lost" state detection                                       src/lib/pool.ts
    [ ] lost state UI + Fortify-to-restore                           src/app/v/[ref]/page.tsx

[ ] SCHEMA UPDATES (trigger: with each feature above)
    [ ] CitationEdge: add type="reply", poolSats field               prisma/schema.prisma
    [ ] HostCapacity, EvictionEvent models                           prisma/schema.prisma
    [ ] indexAttribution fields on Settlement                        prisma/schema.prisma
    [ ] IndexDelegation, IndexBeneficiary models                     prisma/schema.prisma
    [ ] EdgeArchive, Inscription models                              prisma/schema.prisma
    [ ] TopicNode model, loss tracking fields                        prisma/schema.prisma
