OCDN MVP — Task Checklist
==========================

[x] SCAFFOLD
    [x] next.js app (app router), tailwind, prisma        package.json, tsconfig, next.config
    [x] prisma schema: pools, receipts, settlements,       prisma/schema.prisma
        events, importance scores, citation edges
    [x] env: database url, nostr relay urls, founder       .env
        pubkey, mint keys
    [x] protocol constants                                 src/lib/constants.ts

[x] PROTOCOL TYPES (NIP definitions)
    [x] event kind numbers, tag shapes, zod schemas        src/lib/nostr/types.ts
    [x] NIP-POOL: pool credit event build/validate         src/lib/nostr/pool.ts
    [x] NIP-RECEIPT: receipt event build/validate           src/lib/nostr/receipt.ts
    [x] NIP-SETTLE: settlement event build/validate        src/lib/nostr/settle.ts
    [x] NIP-PRESERVE: preservation bid build/validate      src/lib/nostr/preserve.ts
    [x] NIP-OFFER: host offer build/validate               src/lib/nostr/offer.ts
    [x] NIP-CLEARING: clearing result build/validate       src/lib/nostr/clearing.ts

[x] CORE LOGIC
    [x] royalty formula r(v) + split accounting             src/lib/royalty.ts
    [x] pool mechanics: accumulate, drain, epoch cap        src/lib/pool.ts
    [x] receipt verification (ed25519 + pow check)          src/lib/receipt.ts
    [x] importance computation (commitment × demand ×       src/lib/importance/index.ts
        centrality), divergence labels
    [x] citation graph: edge extraction, pagerank           src/lib/importance/graph.ts
    [x] relay subscription client (nostr-tools)             src/lib/nostr/relay.ts
    [x] blossom client (upload, fetch, L402 flow)           src/lib/blossom/client.ts
    [x] prisma client singleton                             src/lib/db.ts

[x] SETTLER / BACKGROUND SERVICES
    [x] relay subscriber: ingest pool+receipt events        src/workers/relay-sub.ts
    [x] epoch settler: compute rewards, publish settle      src/workers/settler.ts
    [x] clearinghouse: match preserve↔offer at boundary     src/workers/clearing.ts

[x] API ROUTES
    [x] GET /api/pool/[hash]: balance, funders, drain       src/app/api/pool/[hash]/route.ts
    [x] GET /api/importance: ranked list, filters            src/app/api/importance/route.ts
    [x] GET /api/events: event stream query                  src/app/api/events/route.ts
    [x] GET /api/sse: server-sent events (live updates)      src/app/api/sse/route.ts
    [x] POST /api/fortify: accept pool credit + payment      src/app/api/fortify/route.ts
    [x] POST /api/preserve: accept preserve bid              src/app/api/preserve/route.ts
    [x] GET /api/resolve/[input]: ref resolver backend       src/app/api/resolve/[input]/route.ts

[x] PAGES
    [x] layout: header, stats bar, nip-07 auth               src/app/layout.tsx
    [x] / leaderboard: ranked feed, expandable cards          src/app/page.tsx
    [x] /v/[ref] content detail: blob embed + instrument      src/app/v/[ref]/page.tsx
        cluster + discussion + fortify + citations
    [x] /verify/[ref] integrity proof page                    src/app/verify/[ref]/page.tsx

[x] COMPONENTS
    [x] LeaderboardFeed + ContentCard (expandable)            src/components/leaderboard/
    [x] InstrumentCluster (funding, demand, replicas,         src/components/content/
        sustainability, citations, preserve backers)
    [x] BlobEmbed (render pdf/image/text from blossom)        src/components/content/BlobEmbed.tsx
    [x] Discussion (nostr threaded replies)                   src/components/content/Discussion.tsx
    [x] CitationList (cited-by / cites, flat)                 src/components/content/CitationList.tsx
    [x] FortifyButton (preserve/fortify/fund modes)           src/components/fortify/FortifyButton.tsx
    [x] RefResolver (paste url/hash/drop file)                src/components/resolve/RefResolver.tsx
    [x] Header + live stats                                   src/components/shared/Header.tsx

[x] WIDGET
    [x] standalone web component: compact leaderboard +       src/widget/embed.ts
        fortify, CDN-ready build

--- INTEGRATION WORK (DONE) ---

[x] WIRING
    [x] real NIP-07 (browser extension) identity flow         src/lib/nostr/identity.ts
    [x] real Lightning payment integration (invoices+WebLN)    src/components/fortify/FortifyButton.tsx
    [x] SSE wiring: connect pages/components to /api/sse      src/hooks/useSSE.ts
    [x] header live stats: fetch doc count, total sats         src/components/shared/Header.tsx + /api/stats
    [x] OG image generation per content hash                   src/app/v/[ref]/opengraph-image.tsx
    [x] file drop support in RefResolver                       src/components/resolve/RefResolver.tsx
    [x] discussion: real nostr event subscription              src/components/content/Discussion.tsx
    [x] ephemeral key → claim funding flow                     src/lib/nostr/identity.ts
    [x] worker startup (settler + relay-sub + clearing)        src/app/api/workers/route.ts

[x] INFRA (partial)
    [x] prisma migrate: create initial migration               prisma/migrations/0001_init/
    [ ] deploy postgres                                        .env DATABASE_URL
    [ ] configure real nostr relay URLs                         .env NOSTR_RELAYS
    [ ] generate + distribute mint keypairs                     .env MINT_PRIVATE_KEY
    [ ] set FOUNDER_PUBKEY                                      .env

--- CORE LOOP: Fortify → Share → Push ---
--- Build as one pipeline. Each step unblocks the next. ---

STEP 1: FORTIFY (simplify the revenue action)

    [x] strip FortifyButton to single mode: button + amount       src/components/fortify/FortifyButton.tsx
        presets (21/100/1k/10k) + pay. kill mode selector,
        kill "fund" mode, hide preserve entirely for now.
    [x] after successful payment: show confirmation + share        src/components/fortify/FortifyButton.tsx
        prompt inline ("You fortified this. Share it.")

STEP 2: SHARE (close the viral loop)

    [x] share button on /v/[ref]: copy link + Nostr + Twitter     src/app/v/[ref]/page.tsx
        (OG card already exists — it IS the payload)
    [x] share button on leaderboard ContentCard                    src/components/leaderboard/Card.tsx
    [x] post-Fortify share: surface share buttons immediately      src/components/fortify/FortifyButton.tsx
        after payment success (Fortify→Share is one motion)

STEP 3: PUSH (let users bring content)

    [x] RefResolver: detect file input, upload to Blossom via      src/components/resolve/RefResolver.tsx
        uploadBlob(), create pool entry via POST /api/push,        src/lib/blossom/client.ts
        redirect to /v/{hash}
    [x] POST /api/push: create pool entry + optional announce      src/app/api/push/route.ts
    [x] /v/[ref] not-indexed state: show "Push" CTA instead        src/app/v/[ref]/page.tsx
        of bare Fortify on an empty hash

--- ECOSYSTEM INTEGRATION (DONE) ---

[x] NOSTR RELAY PUBLISHING
    [x] publish NIP-POOL events to relays on fortify               src/app/api/fortify/route.ts
    [x] publish NIP-IMPORTANCE events to relays                    src/workers/settler.ts
    [x] accept inbound Zaps as pool credits                        src/workers/relay-sub.ts

[x] POLISH
    [x] embed code generator ("Embed this" snippet)                src/components/content/EmbedGenerator.tsx
    [x] live activity feed (funding events, new content)           src/components/shared/ActivityFeed.tsx
