# One-Shot Architectural Resolution: M Key Lifecycle (Threshold Migration)

## Your Task

Produce a complete, implementation-ready architectural specification that resolves Unresolved Design Conflict #9 ("M Key Lifecycle") for the OCDN protocol. The output must be a single coherent document covering every subsystem touched by the v1 → Phase 2a → Phase 2b migration of the content decryption key M from "full M distributed to all bonded mints" to "Shamir T-of-N threshold shares with no mint ever holding M." Include concrete data structures, message flows, state machines, failure/recovery procedures, and migration sequencing. Resolve all 7 residual concerns listed at the end of this prompt.

---

## System Context

OCDN is a permissionless storage market built on Nostr and Bitcoin. Four separated roles (store, serve endpoint, mint, genesis) settle at participant parity. Content is doubly-encrypted: an inner convergent layer (deterministic, `key = SHA256(protocol_seed || CONTENT_KEY_DOMAIN || content_hash)`) and an outer mint encryption layer (random key M, per-content). Stores hold encrypted shards behind anonymous transport (Tor hidden services by default). Mints are fidelity-bonded operators behind Tor. Epochs are ~4 hours (24 Bitcoin blocks). All inter-infrastructure communication is over Tor.

### The Role of M

M is a per-content 32-byte random key generated at upload by the verifying mint (VM). It creates the outer encryption layer:

    stored_shard_i = AES(convergent_shard_i, KDF(M, shard_index))

M serves two purposes:
1. **Content-blindness for stores**: Without M, stores could strip the convergent layer (key is deterministic from content_hash + protocol_seed) and identify what they hold. M adds a layer only the mint knows, making store disk contents opaque.
2. **Decryption for readers**: The mint derives per-shard keys `K_shard = KDF(M, shard_index)` and packages them in a sealed key envelope encrypted to the client's pubkey. The serve endpoint carries this envelope opaquely.

### Current v1 Design

- **Upload**: VM generates M, encrypts shards, escrows M to Nostr relays (Argon2-gated: `encrypt(M, key=Argon2id(content_hash || protocol_seed || "ocdn-key-v1", ARGON2_PARAMS))`). Escrow happens BEFORE fund confirmation is published (escrow-before-confirmation atomicity).
- **Gossip**: M distributed to all bonded mints via authenticated gossip as a latency optimization. Any bonded mint can independently recover M from relay escrow at any time.
- **Consumption**: Mint retrieves M (from cache, gossip, or relay escrow), derives K_shard values, packages them in a key envelope encrypted to the client's pubkey. Serve endpoint delivers envelope + blobs. Client decrypts.
- **Degraded mode** (no mint reachable): Serve endpoint recovers M from relay escrow, decrypts content itself. Privacy degrades severely (serve endpoint has full plaintext access).
- **Security property**: Any single compromised mint reveals M for all content it knows about. Content-blindness for stores is computational (M is a speed bump, not an information-theoretic wall).

### Target Architecture (Phased)

**Phase 2a — Shares on disk, transient M in RAM:**
- Shamir T-of-N threshold sharing with Feldman VSS over secp256k1.
- Per-content committees of N_MAX (15) mints selected deterministically: `top N_MAX by H(content_hash || mint_pubkey || "ocdn-committee-v1")`.
- T = max(2, ceil((N+1)/2)) — simple majority, where N = number of bonded mints on the committee (may be < N_MAX if total bonded mints < 15).
- Evaluation points bind shares to mint identity AND content: `x_i = H(mint_pubkey_i || content_hash || "ocdn-share-eval-v1") mod q`.
- VSS commitments `C_j = a_j * G` (public, C_0 = M*G) enable share verification without revealing M.
- Mint reconstructs M from T peer shares on demand (first request per epoch per content pays ~1-2s Tor latency for share collection; subsequent requests use cached M in RAM).
- Key envelope generation unchanged (mint still derives K_shard from M).
- **Security improvement**: Disk seizure reveals shares (information-theoretically zero bits of M for k < T), not full M.

**Phase 2b — Client-side M reconstruction (hardened):**
- T mints each contribute a sealed share (NIP-44, encrypted to client pubkey).
- Client reconstructs M via Lagrange interpolation, verifies each share against VSS commitments, verifies `M * G == C_0` after reconstruction.
- No mint ever has M after Phase 2b.
- Per-shard independent committees for documents (N=20, K=10): `committee(content_hash, shard_index) = top N_MAX by H(content_hash || shard_index || mint_pubkey)`. This gives Tor-like multiplicative sub-linearity: adversary must win K independent committee lotteries. At 30% adversary mints: P(mapping a document) ≈ 0.

**Proactive Secret Sharing (PSS) — per-epoch refresh:**
- Every epoch, committee members refresh the polynomial (each generates a random degree-(T-1) polynomial with zero constant term, distributes sub-shares, accumulates).
- M is invariant (zero constant term preserves a_0). Old shares become incompatible with new shares.
- Collusion window bounded to one epoch (~4h).
- Requires verified-set agreement: committee members broadcast which peers' sub-shares passed VSS verification, compute strict intersection, accumulate only the common set.
- Refresh cost at 1M content, 100 mints: ~5-10 minutes, ~550 MB outbound per mint per epoch.

---

## Every Subsystem That Must Change

### 1. Upload Flow (Fund Confirmation)

**v1**: VM generates M → encrypts shards → escrows M to relays → publishes fund confirmation.
**Target**: VM generates M → creates Shamir shares with Feldman VSS → distributes shares to committee members via Tor point-to-point → escrows VSS commitments + per-mint encrypted shares to relays → publishes fund confirmation.

Questions to resolve:
- What is the relay escrow event format for threshold M (v2)?
- How does the VM distribute shares to committee members who may be behind Tor and potentially offline?
- What happens if fewer than T committee members are reachable during upload?
- Does the HTLC timeout chain (T_vm = 5 min, T_sm = 10 min) still accommodate the additional share distribution latency?
- Fund confirmation currently includes `["m_escrow", event_id]` — what does this point to in v2?

### 2. Consumption Flow (Reading)

**v1**: Mint retrieves M → derives K_shard → packages key envelope → serve endpoint delivers.
**Phase 2a**: Mint collects T shares from peers → reconstructs M in RAM → derives K_shard → packages key envelope → serve endpoint delivers. First request per epoch per content adds ~1-2s Tor latency.
**Phase 2b**: Client requests sealed shares from T committee mints (routed how?) → reconstructs M → derives K_shard → decrypts. The serve endpoint no longer carries K_shard values in the key envelope — it carries sealed shares. Or does the serve endpoint coordinate share collection from multiple mints?

Questions to resolve:
- In Phase 2b, who coordinates share collection? The serve endpoint? The client directly? A new intermediary?
- How does this interact with serve-blinded selection (the commitment-reveal protocol)? The current flow has ONE mint in the loop. Phase 2b requires T mints.
- What is the latency budget? Current hot path is ~2-4s over Tor. Adding T mint contacts over Tor could balloon this.
- How does the key envelope change? Does it still exist? What does it contain?
- How does the client discover which mints are on the committee for a given content_hash?

### 3. Gossip Protocol (Mint-to-Mint)

**v1**: Full M distributed via authenticated gossip. Any bonded mint can also recover from relay escrow.
**Target**: No full M in gossip. Instead: share distribution during upload (VM → committee), PSS refresh messages every epoch (committee ↔ committee), share catch-up for mints that missed a PSS round.

Questions to resolve:
- What messages replace M gossip?
- How does a newly bonded mint that joins a committee acquire its share? (Lazy re-onboarding from T existing members.)
- What is the catch-up protocol when a mint misses a PSS refresh?

### 4. Relay Escrow (Write-Once Events)

**v1**: `encrypt(M, key=Argon2id(content_hash || protocol_seed || "ocdn-key-v1"))` — anyone with correct genesis pubkey can recover M from relay escrow.
**v2 (target)**: Write-once. Contains epoch-0 VSS commitments + per-mint encrypted shares (NIP-44 sealed) + optional emergency blob (hard-Argon2 encrypted M).

Questions to resolve:
- Exact event schema for v2 relay escrow?
- The emergency blob (hard-Argon2 encrypted M) — is this a backdoor that undermines threshold secrecy? What Argon2 parameters make this acceptable?
- Write-once creates an unbounded window for private-key-accumulation attacks (adversary collecting T mint identity keys over time can reconstruct from epoch-0 shares regardless of PSS). Acceptable? Mitigations?
- How does relay pruning interact with write-once escrow? Periodic refresh as anti-pruning — but refresh contradicts write-once.

### 5. Epoch Summary (vss_root)

The epoch summary already includes a `["vss_root", "<merkle_root>"]` tag — Merkle root over per-content VSS commitment tuples `(content_hash, epoch, T, C_0..C_{T-1})`.

Questions to resolve:
- What is the exact leaf format?
- How do external verifiers (settlers, auditors, new mints onboarding) query leaves?
- How does vss_root interact with PSS (commitments change every epoch)?
- Size budget: at 1M content items, how large is the commitment set?

### 6. Degraded Mode

**v1**: Serve endpoint recovers M from relay escrow → decrypts content (severe privacy degradation, but content available).
**Phase 2b**: If no mint is reachable, the serve endpoint cannot collect T shares → content is UNAVAILABLE. This is the impossibility theorem: threshold secrecy and guaranteed recoverability are mutually exclusive.

Questions to resolve:
- Is content unavailability during total mint outage acceptable?
- Does the emergency blob in relay escrow serve as a degraded-mode fallback? If so, doesn't that defeat threshold secrecy?
- What is the formal degradation spectrum? (All mints up → some mints down → < T committee mints up → zero mints up)
- How does this interact with the protocol's core promise that "mint liveness controls economics, not availability"?

### 7. Key Rotation (#17 Interaction)

Share evaluation points bind to mint_pubkey. Key rotation invalidates all shares — the rotating mint must re-onboard under its new key via `KeyHandoff` event.

Questions to resolve:
- Full re-onboarding protocol? (Lazy, on first request per content.)
- At 100 bonded mints, a rotating mint re-onboards ~22,500 content hashes — rate-limited over ~4 days. What is the rate-limiting mechanism?
- Emergency rotation (compromise, `handoff_epoch = current_epoch`): how does PSS handle mid-epoch key changes?
- What happens to content where the rotating mint was part of a T-exact committee (no redundancy)?

### 8. Settlement Interaction

Settlement is per-mint, per-shard, no cross-mint join. Threshold M adds cross-mint coordination (committee members must cooperate). Does this create a new cross-mint coupling in the settlement path?

Questions to resolve:
- Is settlement truly unaffected, or does committee health become a settlement precondition?
- How does the settler verify that the correct committee was used?

### 9. Migration Sequencing (v1 → 2a → 2b)

The hardest part: how does a live system with real funded content transition between phases?

Questions to resolve:
- What triggers Phase 2a activation? (Bonded mint count ≥ 3, per the document.)
- During transition, content uploaded under v1 has full M on relays and in gossip. Does it get retroactively threshold-shared? Or does it remain v1 forever?
- Can v1 content and Phase 2a content coexist? Different key envelope formats? How does the client know which format to expect?
- What triggers Phase 2b activation?
- Is there a Phase 2a → 2b migration for existing content, or only new uploads?
- Content-fork implications: does Phase 2b require a new CONTENT_KEY_DOMAIN?

---

## The 7 Residual Concerns (Must Be Resolved)

**(i) Relay pruning of escrowed M events** — Periodic refresh doubles as anti-pruning. But if escrow is write-once, what does "refresh" mean? Specify the exact anti-pruning mechanism.

**(ii) M recovery path from relay needs integration test** — The full share lifecycle is: generation → escrow → gossip → PSS refresh → onboarding → catch-up → reconstruction. Produce a complete state machine covering all transitions and failure modes.

**(iii) Store-blindness anchors on anonymous transport, not M secrecy** — Threshold M strengthens content-blindness from a computational speed bump to an information-theoretic wall (for k < T compromised mints) but does not change the fundamental security model. Quantify the actual security improvement. Is the complexity justified?

**(iv) M escrow Argon2 salt includes protocol_seed** — A different genesis pubkey cannot recover M from relay escrow. In Phase 2b with per-mint encrypted shares, is the Argon2 gating still relevant? What replaces it?

**(v) Write-once relay escrow creates unbounded window for private-key-accumulation attacks** — Adversary collecting T mint identity keys over time can reconstruct from epoch-0 shares regardless of PSS. The document says "acceptable because compromising T mint identity keys is catastrophic regardless of PSS." Formalize this argument. Is "escrow refresh on committee changes" a future hardening or a requirement?

**(vi) Text content (N=1) has no multiplicative sub-linearity** — Single committee, single shard. Transport anonymity is the primary protection; M secrecy is defense-in-depth. What is the realistic threat model for text content under Phase 2b? Is the threshold overhead justified for N=1?

**(vii) The dome milestone** — PSS is operational and the keystone (founder mint) is removable when N - 1 ≥ T with the founder excluded. Define the exact conditions. What happens to content where the founder mint is the sole VM? What is the handoff protocol?

---

## Constraints

- All inter-mint communication is over Tor (~1-3s per connection).
- Epoch duration is ~4 hours.
- Content must remain readable during migration (no downtime).
- The upload hot path must remain feasible (HTLC timeouts of 5-10 minutes).
- The reading hot path target is ~2-4s (current) — any regression must be quantified.
- Store-blindness must be preserved (stores never learn content_hash or M).
- Settlement must remain per-mint with no cross-mint join.
- The protocol must work with as few as 3 bonded mints (Phase 2a activation threshold).
- Degraded mode behavior must be explicitly specified for every phase.
- Per-shard independent committees (Phase 2b) must be specified for documents (N=20, K=10) and the degenerate case (N=1, text).

## Output Format

Produce a single document with the following sections:

1. **Executive Summary** — One paragraph on the architectural approach.
2. **Phase 2a Specification** — Complete: data structures, message flows, state machines, relay escrow v2 schema, epoch summary changes, consumption flow changes, upload flow changes, degraded mode behavior, migration from v1.
3. **Phase 2b Specification** — Complete: same categories as 2a, plus per-shard committees, client-side reconstruction protocol, key envelope v2 format, serve endpoint role changes.
4. **PSS Specification** — Complete: refresh protocol, verified-set agreement, catch-up protocol, failure modes, bandwidth budget.
5. **Migration Plan** — Sequenced: triggers, coexistence rules, backward compatibility, content-fork implications.
6. **Residual Resolutions** — Each of the 7 concerns addressed with a concrete decision and rationale.
7. **Failure Mode Catalog** — Every failure scenario (mint crash during share distribution, < T mints online, PSS desync, key rotation during refresh, relay pruning, committee member departure) with the recovery procedure.
8. **Latency Budget** — Per-phase, per-flow (upload, first-read, cached-read, degraded), with Tor overhead modeled.
9. **Complexity Audit** — Honest assessment: is the Phase 2b complexity justified relative to the security improvement? Under what conditions should Phase 2b be deferred indefinitely?
